<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Synced Movie</title>
		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body>
		<h1>Now Playing: <span id="videoTitle">movie.mp4</span></h1>
		<video id="video" controls style="width: 100%; height: auto; display: block; max-width: 100%;">
			<source src="/movie.mp4" type="video/mp4">
		</video>

		<h2>Upload a New Video</h2>
		<input type="file" id="uploadInput" accept="video/*">
		<button id="uploadBtn">Set Video</button>

		<progress id="uploadProgress" value="0" max="100" style="width: 300px; display: none;"></progress>

		<h3>Select Video:</h3>
		<select id="videoSelector"></select>

		<script>
			const socket = io();
			const video = document.getElementById('video');
			const title = document.getElementById('videoTitle');
			const selector = document.getElementById('videoSelector');

			let isSyncing = false;
			let syncTimeout = null;

			function startSyncGuard() {
				isSyncing = true;
				clearTimeout(syncTimeout);
				syncTimeout = setTimeout(() => isSyncing = false, 250);
			}

			// Load current video and list
			fetch('/current-video').then(res => res.json()).then(data => {
				if (data.filename) {
					video.src = '/movie.mp4?' + Date.now();
					title.textContent = data.filename;
				}
			});

			fetch('/video-list').then(res => res.json()).then(data => {
				updateDropdown(data.videos);
			});

			function updateDropdown(videos) {
				selector.innerHTML = '';
				videos.forEach(name => {
					const option = document.createElement('option');
					option.value = name;
					option.textContent = name;
					selector.appendChild(option);
				});
			}

			// Dropdown change triggers video switch
			selector.addEventListener('change', () => {
				const selected = selector.value;
				fetch('/set-video', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ filename: selected })
				});
			});

			// Upload logic
			document.getElementById('uploadBtn').addEventListener('click', () => {
				const input = document.getElementById('uploadInput');
				const progress = document.getElementById('uploadProgress');

				if (!input.files.length) return alert('Choose a file first.');
				const file = input.files[0];
				const formData = new FormData();
				formData.append('video', file);

				const xhr = new XMLHttpRequest();
				xhr.open('POST', '/upload', true);
				progress.style.display = 'inline-block';
				progress.value = 0;

				xhr.upload.onprogress = (event) => {
					if (event.lengthComputable) {
						progress.value = (event.loaded / event.total) * 100;
					}
				};

				xhr.onload = () => progress.style.display = 'none';
				xhr.onerror = () => {
					alert('Upload error.');
					progress.style.display = 'none';
				};

				xhr.send(formData);
			});

			// Sync playback
			socket.on('syncState', (state) => {
				startSyncGuard();
				video.currentTime = state.paused
					? state.currentTime
					: state.currentTime + (Date.now() - state.lastUpdate) / 1000;
				state.paused ? video.pause() : video.play();
			});

			socket.on('play', time => {
				startSyncGuard(); video.currentTime = time; video.play();
			});

			socket.on('pause', time => {
				startSyncGuard(); video.currentTime = time; video.pause();
			});

			socket.on('seek', time => {
				startSyncGuard(); video.currentTime = time;
			});

			socket.on('videoChanged', (filename) => {
				startSyncGuard();
				title.textContent = filename;
				video.src = '/movie.mp4?' + Date.now();
				video.load();
				video.currentTime = 0;
			});

			socket.on('videoListChanged', (videos) => {
				updateDropdown(videos);
			});

			// Emit user actions
			video.addEventListener('play', () => { if (!isSyncing) socket.emit('play', video.currentTime); });
			video.addEventListener('pause', () => { if (!isSyncing) socket.emit('pause', video.currentTime); });
			video.addEventListener('seeked', () => { if (!isSyncing) socket.emit('seek', video.currentTime); });

		</script>

	</body>
</html>